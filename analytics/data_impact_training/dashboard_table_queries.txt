CREATE TABLE
  zachwilson.dashboard_lab (
    host VARCHAR,
    source VARCHAR,
    browser_type VARCHAR,
    os_type VARCHAR,
    device_type VARCHAR,
    event_date DATE,
    site_hits BIGINT,
    num_successful_payments BIGINT,
    num_signup_visits BIGINT,
    num_queries_ran BIGINT,
    aggregation_level VARCHAR
  )
WITH
  (
    FORMAT = 'PARQUET',
    partitioning = ARRAY['aggregation_level']
  )



INSERT INTO
  zachwilson.dashboard_lab
WITH
  conformed AS (
    SELECT
      *,
      CASE
        WHEN host LIKE '%dataengineer%' THEN 'DataEngineer.io'
        WHEN host LIKE '%zachwilson%' THEN 'ZachWilson.tech'
        WHEN host LIKE '%eczachly%' THEN 'EcZachly.com'
        ELSE 'Other'
      END AS conformed_host,
      CASE
        WHEN referrer IS NULL THEN 'Direct'
        WHEN referrer LIKE '%stripe%' THEN 'Stripe'
        WHEN referrer LIKE '%linkedin%' THEN 'LinkedIn'
        WHEN referrer LIKE '%blog.dataengineer.io%' THEN 'Substack'
        WHEN referrer LIKE '%tiktok%' THEN 'TikTok'
        WHEN referrer LIKE '%instagram%' THEN 'Instagram'
        WHEN referrer LIKE '%t.co%' THEN 'Twitter'
        WHEN referrer LIKE '%eczachly%' THEN 'On Site'
        WHEN referrer LIKE '%zachwilson.tech%' THEN 'On Site'
        WHEN referrer LIKE '%eczachly.com%' THEN 'On Site'
        ELSE 'Other'
      END AS conformed_source,
      DATE(event_time) AS event_date,
      DATE(DATE_TRUNC('month', event_time)) AS event_month
    FROM
      bootcamp.web_events we
      JOIN bootcamp.devices d ON we.device_id = d.device_id
  )
SELECT
  COALESCE(conformed_host, '(overall)') AS conformed_host,
  COALESCE(conformed_source, '(overall)') AS conformed_source,
  COALESCE(browser_type, '(overall)') AS browser_type,
  COALESCE(os_type, '(overall)') AS os_type,
  COALESCE(device_type, '(overall)') AS device_type,
  event_date AS event_date,
  COUNT(*) AS site_hits,
  COUNT(
    CASE
      WHEN url LIKE '%payment_successful%' THEN 1
    END
  ) AS num_successful_payments,
  COUNT(
    CASE
      WHEN url LIKE '%/signup%' THEN 1
    END
  ) AS num_signup_visits,
  COUNT(
    CASE
      WHEN url LIKE '%query%' THEN 1
    END
  ) AS num_queries_ran,
  CASE
    WHEN GROUPING (conformed_host) = 0
    AND GROUPING (conformed_source) = 0 THEN 'event_date__host__source'
    WHEN GROUPING (conformed_host) = 0 THEN 'event_date__host'
    WHEN GROUPING (conformed_source) = 0 THEN 'event_date__source'
    ELSE 'event_date__browser_type__device_type__os_type'
  END AS aggregation_level
FROM
  conformed
GROUP BY
  GROUPING SETS (
    (conformed_host, event_date),
    (conformed_source, event_date),
    (conformed_host, conformed_source, event_date),
    (browser_type, os_type, device_type, event_date)
  )


The instructor just ran (click TO copy TO clipboard)
SELECT
  *
FROM
  zachwilson.dashboard_lab
WHERE
  aggregation_level = 'event_date__source'


SELECT
  DATE_TRUNC('month', event_date) AS MONTH,
  source,
  SUM(num_signup_visits)
FROM
  zachwilson.dashboard_lab
WHERE
  aggregation_level = 'event_date__source'
GROUP BY
  1,
  2
ORDER BY
  1 DESC